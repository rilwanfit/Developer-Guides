### CQRS: Search Queries

#### benefits of using CQRS



1.  You can completely isolate reading data from writing data. 
    1.  This allows architecting around[ slices instead of layers](https://vimeo.com/131633177). The less cross-cutting concerns exist in your application the more rapidly change can be realized.
    1.  Help to easily manage the complexity of state changes
        1.  In most projects using web frameworks - where the state of models is managed using the framework's own ORM through CRUD operations - sometimes managing the state of complex models like [aggregate roots](https://martinfowler.com/bliki/DDD_Aggregate.html) can become difficult.


#### Command and Queries


<table>
  <tr>
   <td>
<h5>Command</h5>

<ul>

<li>Does something,
<li>Should modify the state of the system
<li>Should NOT return a value</li></ul>

   </td>
   <td>
<h5>Queries</h5>

<ul>

<li>Answers a question
<li>Should NOT modify the state of the system
<li>Should return a value</li></ul>

   </td>
  </tr>
</table>


Back in 1988 Bertrand Meyor taught us that we should attempt to maintain command query separation where possible. It is a good idea because for example, to avoid nasty side effect that hide in methods that violate this principle. 

However, as Martin Fowler points out, this is not always possible. For example, if you have a stack, and you want to pop the first item on the stack, the pop method removes the top item from the stack, which is a command, and returns that top item, which is a query.

In addition, if you want to create a new database record you create the database record, which is a command, but you might also need to return the newly created ID, which is a query.

Command Query Responsibility Separation (CQRS) architecture expand this concept command query separation to the architectural level.


<table>
  <tr>
   <td>

<p id="gdcalert1" ><span style="color: red; font-weight: bold">>>>>>  gd2md-html alert: inline image link here (to images/DDD0.png). Store image on your image server and adjust path/filename if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert2">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>>> </span></p>


<img src="images/DDD0.png" width="" alt="alt_text" title="image_tooltip">

<p>
Single database CQRS
   </td>
   <td>

<p id="gdcalert2" ><span style="color: red; font-weight: bold">>>>>>  gd2md-html alert: inline image link here (to images/DDD1.png). Store image on your image server and adjust path/filename if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert3">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>>> </span></p>


<img src="images/DDD1.png" width="" alt="alt_text" title="image_tooltip">

<p>
Two database CQRS
   </td>
   <td>

<p id="gdcalert3" ><span style="color: red; font-weight: bold">>>>>>  gd2md-html alert: inline image link here (to images/DDD2.png). Store image on your image server and adjust path/filename if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert4">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>>> </span></p>


<img src="images/DDD2.png" width="" alt="alt_text" title="image_tooltip">

<p>
Event Sourcing CQRS
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>
   </td>
   <td>
   </td>
  </tr>
</table>


[https://matthiasnoback.nl/2015/07/experimenting-with-broadway/](https://matthiasnoback.nl/2015/07/experimenting-with-broadway/)

[https://kalele.io/blog-posts/really-simple-cqrs/](https://kalele.io/blog-posts/really-simple-cqrs/)


### Saga

 It refers to a piece of code that coordinates and routes messages between bounded contexts and aggregates.

[https://docs.microsoft.com/en-us/previous-versions/msp-n-p/jj591569(v=pandp.10)](https://docs.microsoft.com/en-us/previous-versions/msp-n-p/jj591569(v=pandp.10))

[https://medium.com/@marinithiago/doing-event-sourcing-without-building-a-spaceship-6dc3e7eac000](https://medium.com/@marinithiago/doing-event-sourcing-without-building-a-spaceship-6dc3e7eac000)


##### What is the problem I'm trying to solve?

in our domain we have an aggregate root called "Shipment". Logically speaking a shipment gets passed around in many apps (ours and third party). And also physically, from the seller of a product, to our drivers, then to our warehouse, then to a carrier to finally being delivered to the buyer/recipient.

Shipments hold loads of information, and it changes all the time.


##### How I want to solve it

- I want to write in an immutable, append only fashion.

- I also want to read the current state fast.

- If I bump into any issue I need to fix it fast.

- I need all events logged.

- I want to save some metadata with the events so I can debug with some luxury.


##### Some important guidelines to follow:

- Calculating state should be done ONCE, perhaps before events get appended/saved?

- There has to be a safety net so outdated events don't get appended causing inconsistent state.

- It HAS to be change friendly. If events need to change it should be no problem and we should know from which point the change happened.

- And if you ever need to replay all events to recalculate the current state it should be easy to do, even with changes in the data structure.

- Serialising/deserialising should be a breeze and done by PHP built-in functions.


##### The "inconsistent state" problem

Before each write we should ask for the version of the last event, then we can save the new event with the version incremented. There should never exist repeated versions of the same entity.

The "replaying of events to create snapshots" problem

We should go a bit reducer here: previous state + action returns a new state. If the last event holds the current state it's a way of caching, isn't it? Reading will be easy and fast.


##### The "upgrading events" problem

Let's go real immutable about it. If the reducers are versioned and never change, we wouldn't need to deal with changes on read time.


##### The ingredients

Event: has the current state, ID of the entity, action being applied. Saving the current state brings a bit of criticism to the solution, some people argue events should be pure and just represent an action taken. Just take in consideration that the current state will be used as the previous state for the next event. And in the end it's always possible to recalculate the current state only with actions and reducers. So saving the current state is just for convenience and ease of use.

Action: has a name, version and the data necessary for the reducers to do the change.

Store: persists and retrieves the events. Internally it uses the events to match reducers with actions.

Reducers: basically an array of versioned callables given to the stores.

TODO Apps

1. user should be able to create/edit and remove a Todo

2. Todo has a small text and is either completed or not.

3. user should be able to view a list of all Todo's in the system


### Broadway


#### Auditing



1.  Instantiate CommandHandling\CommandHandler
1.  Instantiate EventDispatcher\EventDispatcher
1.  Instantiate CommandHandling\SimpleCommandBus
1.  Create Event Dispatching CommandBus using SimpleCommandBus and EventDispatcher
1.  

[https://vaughnvernon.co/](https://vaughnvernon.co/)

[http://shadowhand.me/cqrs-search-queries/](http://shadowhand.me/cqrs-search-queries/)

[http://shadowhand.me/announcing-equip/](http://shadowhand.me/announcing-equip/)

[https://martinfowler.com/bliki/CQRS.html](https://martinfowler.com/bliki/CQRS.html)